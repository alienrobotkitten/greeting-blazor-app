@page "/"
@page "/inbox"
@inject StateService stateService
@implements IDisposable
@using BlazorApp.Entities

<PageTitle>GreetingService</PageTitle>

@if (GreetingList == null)
{
    <p class="pad-10"><em>Loading...</em></p>
}
else
{
    <FolderView ThisFolder=Folder.Inbox
            GreetingList=this.GreetingList />
}

@code {

    public List<Greeting> GreetingList { get; set; }
    private List<Greeting> completeList { get; set; }

    private HttpClient HttpClient { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        stateService.OnChange += FilterGreetings;

        HttpClient = new();
        HttpClient.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Basic", "a2Fqc2FAYW5rZWJvcmcuY29tOnRlc3Q=");

        await GetPage();
    }

    private void FilterGreetings()
    {
        GreetingList = FilterGreetings(stateService.CurrentUser);
        StateHasChanged();
    }

    private List<Greeting> FilterGreetings(string userName)
    {
        var filteredItems = from g in completeList
            where g.To == stateService.CurrentUser
            select g;
        var filteredList = filteredItems.ToList();
        var comp = new GreetingNewest();
        filteredList.Sort(comp);
        return filteredList;
    }

    private async Task GetPage()
    {
        var result = await HttpClient.GetAsync("https://helenatestdev.azurewebsites.net/api/greeting");
        var resultAsString = await result.Content.ReadAsStringAsync();
        try
        {
            completeList = JsonConvert.DeserializeObject<List<Greeting>>(resultAsString);
            GreetingList = FilterGreetings(stateService.CurrentUser);
        }
        catch (Exception)
        {
            GreetingList = null;
        }
    }

    public void Dispose()
    {
        stateService.OnChange -= FilterGreetings;
    }
}